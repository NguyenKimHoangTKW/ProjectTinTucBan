@{
    ViewBag.Title = "Quản lý Đơn vị trực thuộc";
    Layout = "~/Areas/Admin/Views/Shared/_AdminLayout.cshtml";
}

<h2>Quản lý Đơn vị trực thuộc</h2>

<div class="mb-3">
    <button id="btnLoadDonVi" class="btn btn-info">Tải danh sách</button>
    <button type="button" class="btn btn-primary ml-2" id="btnShowDonViModal">
        Thêm Đơn vị trực thuộc
    </button>
</div>

<div class="row mb-3">
    <div class="col-md-4">
        <label for="filterKhoi">Lọc theo Khối:</label>
        <select id="filterKhoi" class="form-control">
            <option value="">-- Tất cả Khối --</option>
        </select>
    </div>
</div>

<!-- DataTable cho Đơn vị trực thuộc -->
<div class="table-responsive">
    <table id="data-table" class="table">
        <thead>
            <tr>
                <th>ID</th>
                <th>Tên đơn vị</th>
                <th>Khối trực thuộc</th>
                <th>Thứ tự</th>
                <th>Link</th>
                <th>Ngày đăng</th>
                <th>Ngày cập nhật</th>
                <th>Hành động</th>
            </tr>
        </thead>
        <tbody>
        </tbody>
    </table>
</div>

<!-- Modal Thêm/Sửa Đơn vị trực thuộc -->
<div class="modal fade" id="donViModal" tabindex="-1" role="dialog" aria-labelledby="donViModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="donViModalLabel">Thêm/Sửa Đơn vị trực thuộc</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Đóng">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="donViForm">
                    <input type="hidden" id="ID" />
                    <div class="form-group">
                        <label for="ID_Khoi">Khối trực thuộc</label>
                        <select class="form-control" id="ID_Khoi" required>
                            <option value="">-- Chọn Khối --</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="TenDonVi">Tên đơn vị</label>
                        <input type="text" class="form-control" id="TenDonVi" required />
                    </div>
                    <div class="form-group">
                        <label for="ThuTuShow">Thứ tự</label>
                        <input type="number" class="form-control" id="ThuTuShow" />
                    </div>
                    <div class="form-group">
                        <label for="Link">Link</label>
                        <input type="text" class="form-control" id="Link" />
                    </div>
                    <div class="modal-footer d-flex flex-column flex-sm-row justify-content-center align-items-center w-100">
                        <button type="submit" class="btn btn-success mb-2 mb-sm-0 mr-0 mr-sm-2 w-100 w-sm-auto">Lưu</button>
                        <button type="button" class="btn btn-secondary mb-2 mb-sm-0 mr-0 mr-sm-2 w-100 w-sm-auto" id="btnClear">Xóa form</button>
                        <button type="button" class="btn btn-danger w-100 w-sm-auto" data-dismiss="modal">Đóng</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

@section scriptsAdmin {
    <!-- CSS và Responsive styles -->
    <style>
        /* Responsive cho modal trên mobile */
        @@media (max-width: 575.98px) {
            .modal-dialog {
                max-width: 100vw !important;
                width: 100vw !important;
                margin: 0 !important;
                min-height: 100vh;
                display: flex;
                align-items: center;
            }

            .modal-content {
                border-radius: 0.5rem;
                width: 100vw !important;
                min-height: 100vh;
            }

            .modal-body, .modal-content, .modal-header, .modal-footer {
                width: 100% !important;
                box-sizing: border-box;
            }

            .modal {
                padding-right: 0 !important;
            }
        }
        /* Căn giữa modal tuyệt đối trên mọi màn hình */
        .modal-dialog {
            margin-left: auto !important;
            margin-right: auto !important;
        }
        /* Loại bỏ margin mặc định của modal trên màn hình lớn */
        @@media (min-width: 576px) {
            .modal-dialog {
                margin-top: 2rem;
                margin-bottom: 2rem;
            }
        }
        /* Responsive cho bảng */
        .table-responsive {
            overflow-x: auto;
        }

        .table th, .table td {
            vertical-align: middle !important;
            white-space: nowrap;
        }
    </style>


    <!-- Script xử lý cho Đơn vị trực thuộc -->
    <script>
        // Hàm chuyển Unix timestamp thành chuỗi ngày giờ
        function unixToDateTimeString(unix) {
            if (!unix || unix == 0) return '';
            var date = new Date(unix * 1000);
            // Định dạng: dd/MM/yyyy HH:mm:ss
            var day = ('0' + date.getDate()).slice(-2);
            var month = ('0' + (date.getMonth() + 1)).slice(-2);
            var year = date.getFullYear();
            var hours = ('0' + date.getHours()).slice(-2);
            var minutes = ('0' + date.getMinutes()).slice(-2);
            var seconds = ('0' + date.getSeconds()).slice(-2);
            return `${day}/${month}/${year} ${hours}:${minutes}:${seconds}`;
        }

        // Biến lưu trữ dữ liệu Khối
        var danhSachKhoi = [];
        var dataTable;

        // Load danh sách Khối
        function loadDanhSachKhoi() {
            return $.ajax({
                url: '/api/Khoi',
                type: 'GET',
                success: function (data) {
                    danhSachKhoi = data;
                    // Cập nhật dropdown filter
                    var options = '<option value="">-- Tất cả Khối --</option>';
                    // Cập nhật dropdown trong form
                    var formOptions = '<option value="">-- Chọn Khối --</option>';

                    $.each(data, function (i, item) {
                        options += `<option value="${item.id}">${item.tenKhoi}</option>`;
                        formOptions += `<option value="${item.id}">${item.tenKhoi}</option>`;
                    });

                    $('#filterKhoi').html(options);
                    $('#ID_Khoi').html(formOptions);
                }
            });
        }

        // Khởi tạo DataTable
        function initDataTable() {
            dataTable = $('#data-table').DataTable({
                "processing": true,
                "serverSide": false,
                "searching": true,
                "ordering": true,
                "paging": true,
                "lengthMenu": [10, 25, 50, 100],
                "data": [],
                "columns": [
                    { "data": "id" },
                    { "data": "tenDonVi" },
                    {
                        "data": "idKhoi",
                        "render": function (data) {
                            var khoi = danhSachKhoi.find(k => k.id === data);
                            return khoi ? khoi.tenKhoi : '';
                        }
                    },
                    { "data": "thuTuShow" },
                    { "data": "link" },
                    {
                        "data": "ngayDang",
                        "render": function (data) {
                            return unixToDateTimeString(data);
                        }
                    },
                    {
                        "data": "ngayCapNhat",
                        "render": function (data) {
                            return unixToDateTimeString(data);
                        }
                    },
                    {
                        "data": null,
                        "orderable": false,
                        "render": function (data) {
                            return `
        <div class="text-center d-flex flex-column align-items-center">
            <button class="btn btn-warning btn-sm py-1 px-2 w-100 btn-sua-donvi" data-id="${data.id}" style="max-width: 80px;">Sửa</button>
            <button class="btn btn-danger btn-sm py-1 px-2 w-100 mt-1 btn-xoa-donvi" data-id="${data.id}" style="max-width: 80px;">Xóa</button>
        </div>
    `;
                        }
                    }
                ],
                "language": {
                    "lengthMenu": "Hiển thị _MENU_ dòng",
                    "zeroRecords": "Không tìm thấy dữ liệu",
                    "info": "Trang _PAGE_ / _PAGES_",
                    "infoEmpty": "Không có dữ liệu",
                    "infoFiltered": "(lọc từ _MAX_ dòng)",
                    "search": "Tìm kiếm:",
                    "paginate": {
                        "first": "Đầu",
                        "last": "Cuối",
                        "next": "Sau",
                        "previous": "Trước"
                    }
                }
            });
        }

        // Load danh sách đơn vị trực thuộc
        function loadDonViTrucThuoc(idKhoi) {
            var url = '/api/Admin/DonViTrucThuoc';
            if (idKhoi) {
                url = '/api/Admin/DonViTrucThuoc/ByKhoi/' + idKhoi;
            }
            $.ajax({
                url: url,
                type: 'GET',
                success: function (data) {
                    dataTable.clear().rows.add(data).draw();
                },
                error: function (xhr) {
                    Swal.fire('Lỗi!', 'Không thể tải dữ liệu.', 'error');
                    console.error(xhr);
                }
            });
        }

        // Hàm chỉnh sửa đơn vị
        function editDonVi(id) {
            $.ajax({
                url: '/api/Admin/DonViTrucThuoc/' + id,
                type: 'GET',
                success: function (item) {
                    $('#ID').val(item.id);
                    $('#ID_Khoi').val(item.idKhoi);
                    $('#TenDonVi').val(item.tenDonVi);
                    $('#ThuTuShow').val(item.thuTuShow);
                    $('#Link').val(item.link);

                    // Hiển thị modal
                    $('#donViModal').modal('show');
                },
                error: function (xhr) {
                    Swal.fire('Lỗi!', 'Không thể tải thông tin đơn vị.', 'error');
                    console.error(xhr);
                }
            });
        }

        // Hàm xóa đơn vị
        function deleteDonVi(id) {
            Swal.fire({
                title: 'Bạn chắc chắn muốn xóa?',
                text: "Hành động này không thể hoàn tác!",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#3085d6',
                confirmButtonText: 'Xóa',
                cancelButtonText: 'Hủy'
            }).then((result) => {
                if (result.isConfirmed) {
                    $.ajax({
                        url: '/api/Admin/DonViTrucThuoc/' + id,
                        type: 'DELETE',
                        success: function () {
                            loadDonViTrucThuoc($('#filterKhoi').val());
                            Swal.fire(
                                'Đã xóa!',
                                'Đơn vị trực thuộc đã được xóa thành công.',
                                'success'
                            );
                        },
                        error: function (xhr) {
                            Swal.fire('Lỗi!', 'Không thể xóa đơn vị.', 'error');
                            console.error(xhr);
                        }
                    });
                }
            });
        }

        $(document).ready(function () {
            // Load danh sách Khối
            loadDanhSachKhoi().then(function () {
                // Khởi tạo DataTable sau khi đã load danh sách Khối
                initDataTable();
                // Load dữ liệu ban đầu
                loadDonViTrucThuoc();
            });

            // Lọc theo Khối
            $('#filterKhoi').change(function () {
                loadDonViTrucThuoc($(this).val());
            });

            // Nút tải lại danh sách
            $('#btnLoadDonVi').click(function () {
                loadDonViTrucThuoc($('#filterKhoi').val());
            });

            // Mở modal thêm mới
            $('#btnShowDonViModal').click(function () {
                $('#ID').val('');
                $('#donViForm')[0].reset();
                $('#donViModal').modal('show');
            });

            // Xử lý form submit
            $('#donViForm').submit(function (e) {
                e.preventDefault();

                var id = $('#ID').val();
                var donVi = {
                    ID_Khoi: $('#ID_Khoi').val(),
                    TenDonVi: $('#TenDonVi').val(),
                    ThuTuShow: $('#ThuTuShow').val(),
                    Link: $('#Link').val()
                };

                if (id) {
                    // Cập nhật
                    $.ajax({
                        url: '/api/Admin/DonViTrucThuoc/' + id,
                        type: 'PUT',
                        data: JSON.stringify(donVi),
                        contentType: 'application/json',
                        success: function () {
                            $('#donViForm')[0].reset();
                            $('#ID').val('');
                            $('#donViModal').modal('hide');
                            loadDonViTrucThuoc($('#filterKhoi').val());
                            Swal.fire('Thành công!', 'Đã cập nhật đơn vị.', 'success');
                        },
                        error: function (xhr) {
                            Swal.fire('Lỗi!', 'Không thể cập nhật đơn vị.', 'error');
                            console.error(xhr);
                        }
                    });
                } else {
                    // Thêm mới
                    $.ajax({
                        url: '/api/Admin/DonViTrucThuoc',
                        type: 'POST',
                        data: JSON.stringify(donVi),
                        contentType: 'application/json',
                        success: function () {
                            $('#donViForm')[0].reset();
                            $('#donViModal').modal('hide');
                            loadDonViTrucThuoc($('#filterKhoi').val());
                            Swal.fire('Thành công!', 'Đã thêm đơn vị mới.', 'success');
                        },
                        error: function (xhr) {
                            Swal.fire('Lỗi!', 'Không thể thêm đơn vị mới.', 'error');
                            console.error(xhr);
                        }
                    });
                }
            });

            // Nút xóa form
            $('#btnClear').click(function () {
                $('#donViForm')[0].reset();
                $('#ID').val('');
            });

            // Gán sự kiện cho nút sửa, xóa
            $(document).on('click', '.btn-sua-donvi', function () {
                var id = $(this).data('id');
                editDonVi(id);
            });

            $(document).on('click', '.btn-xoa-donvi', function () {
                var id = $(this).data('id');
                deleteDonVi(id);
            });
        });
    </script>
}

<!-- DataTables CSS -->
<link rel="stylesheet" href="https://cdn.datatables.net/1.10.24/css/dataTables.bootstrap4.min.css">

<!-- jQuery và Bootstrap JS (Sử dụng jQuery 3.5.1 cho tương thích với Bootstrap 4) -->
<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>

<!-- DataTables JS -->
<script src="https://cdn.datatables.net/1.10.24/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.10.24/js/dataTables.bootstrap4.min.js"></script>

<!-- SweetAlert2 -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>